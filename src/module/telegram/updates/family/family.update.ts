import { Action, Ctx, Hears, Message, On, Scene, SceneEnter, Sender } from 'nestjs-telegraf';
import { HttpException, Logger, NotFoundException, UseFilters } from '@nestjs/common';
import { TelegrafExceptionFilter } from '../../filters/telegraf-exception.filter';
import { Context, SenderTelegram } from '../../interfaces/telegram.context';
import { WizardContext } from 'telegraf/typings/scenes';
import { isAccountIdPipe } from '../../pipes/isAccountId.pipe';
import { FAMILY_INPUT_SCENE, FAMILY_INVITE_SCENE } from '../../scenes/family.scene';
import { PhoneName } from '../../interfaces/person.interface';
import { isPhoneNamePipe } from '../../pipes/isPhone.pipe';
import { FamilyService } from './family.service';
import { BaseUpdate } from '../base/base.update';
import { ALL_KEYS_MENU_BUTTON_NAME, FAMILY } from '../base-command/base-command.constants';
import { getMainMenuKeyboard } from '../../keyboards/base.keyboard';
import { ERROR_FOUND_USER } from '../../constants/error.constant';

@Scene(FAMILY.scene)
@UseFilters(TelegrafExceptionFilter)
export class FamilyUpdate extends BaseUpdate {
    @SceneEnter()
    async onSceneEnter(@Ctx() ctx: Context, @Sender() sender: SenderTelegram) {
        await this.createOrUpdateUserTelegram(sender.first_name, sender.id);
        await ctx.reply('üîë –ü—Ä–∏—à–ª–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:');
    }

    @Hears(ALL_KEYS_MENU_BUTTON_NAME)
    async exit(@Message('text') menuBtn: string, @Ctx() ctx: WizardContext) {
        await this.telegramService.exitScene(menuBtn, ctx);
    }

    @On('text')
    async findAccount(
        @Message('text', new isAccountIdPipe()) accountId: string,
        @Sender() sender: SenderTelegram,
        @Ctx() ctx: WizardContext,
    ) {
        await this.telegramService.setTelegramAccountCache(String(sender.id), accountId);
        await ctx.scene.enter(FAMILY_INPUT_SCENE);
    }
}

@Scene(FAMILY_INPUT_SCENE)
@UseFilters(TelegrafExceptionFilter)
export class FamilyInputAccountUpdate extends BaseUpdate {
    private readonly logger = new Logger(FamilyInputAccountUpdate.name);
    constructor(private readonly familyService: FamilyService) {
        super();
    }

    @SceneEnter()
    async onSceneEnter(@Ctx() ctx: Context, @Sender() sender: SenderTelegram) {
        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);
        const user = await this.userService.getUserByTelegramId(String(telegramId));
        if (!user?.role) throw new NotFoundException(ERROR_FOUND_USER);

        this.logger.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –≤–æ—à–µ–ª –≤ —Å—Ü–µ–Ω—É —Å–µ–º—å–∏`);

        try {
            const { text, keyboard } = await this.familyService.getFamilyView(accountId, user.role);
            await ctx.reply(text, keyboard);
        } catch (e: any) {
            await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ');
        }
    }

    @Hears(ALL_KEYS_MENU_BUTTON_NAME)
    async exit(@Message('text') menuBtn: string, @Ctx() ctx: WizardContext) {
        await this.telegramService.exitScene(menuBtn, ctx);
    }

    @Action('refresh_info_family')
    async refreshInfoFamily(@Ctx() ctx: WizardContext, @Sender() sender: SenderTelegram) {
        this.logger.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ–º—å–∏`);
        try {
            await ctx.deleteMessage();
        } catch (e: any) {}
        await ctx.scene.reenter();
    }

    @Action(/exclude_\d+_\d+/)
    async excludeFromFamily(@Ctx() ctx: WizardContext, @Sender() sender: SenderTelegram) {
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        //@ts-ignore
        const [, familyId, memberId] = ctx.match[0].split('_');

        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ —Å–µ–º—å–∏ accountId ${accountId}`);

        try {
            await this.familyService.excludeMemberFamily(accountId, { familyId, memberId });
            await ctx.deleteMessage();
            await ctx.reply('üò¢ –û–Ω —É—à–µ–ª –æ—Ç –Ω–∞—Å');
        } catch (e: any) {
            await ctx.deleteMessage();
            if (e instanceof NotFoundException) {
                await ctx.reply(`‚ùå ${e.message}`);
            } else {
                await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–µ–º—å–∏');
            }
        } finally {
            await ctx.scene.reenter();
        }
    }

    @Action('leave_family')
    async leaveFamily(@Ctx() ctx: WizardContext, @Sender() sender: SenderTelegram) {
        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–∞–∑–≤–∞–ª–∏—Ç—å —Å–µ–º—å—é –¥–ª—è accountId ${accountId}`);

        try {
            await this.familyService.leaveFamily(accountId);
            await ctx.deleteMessage();
            await ctx.reply('üëú –í—ã —É—à–ª–∏ –∑–∞ —Ö–ª–µ–±–æ–º');
        } catch (e: any) {
            await ctx.deleteMessage();
            await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–µ–º—å–∏');
        } finally {
            await ctx.scene.reenter();
        }
    }

    @Action('invite_member')
    async inviteMemberIntoFamily(@Ctx() ctx: WizardContext) {
        await ctx.scene.enter(FAMILY_INVITE_SCENE);
    }

    @Action('accept_family')
    async onAccept(@Ctx() ctx: Context, @Sender() sender: SenderTelegram) {
        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(
            `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —Å–µ–º—å—é –¥–ª—è accountId ${accountId}`,
        );
        try {
            await this.familyService.answerInvite(accountId, true);
            await ctx.deleteMessage();
            await ctx.reply('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç');
            await ctx.scene.leave();
            const user = await this.familyService.getUserByTelegramId(telegramId);
            await ctx.reply('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', getMainMenuKeyboard(user!.role));
        } catch (e: any) {
            await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
            return ctx.scene.reenter();
        }
    }

    @Action('reject_family')
    async onReject(@Ctx() ctx: Context, @Sender() sender: SenderTelegram) {
        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(
            `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∏–∑ —Å–µ–º—å–∏ –¥–ª—è accountId ${accountId}`,
        );

        try {
            await this.familyService.answerInvite(accountId, false);
            await ctx.deleteMessage();
            await ctx.reply('üö´ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
            await ctx.scene.reenter();
        } catch (e: any) {
            await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏');
            return ctx.scene.reenter();
        }
    }
}

@Scene(FAMILY_INVITE_SCENE)
@UseFilters(TelegrafExceptionFilter)
export class FamilyInviteUpdate extends BaseUpdate {
    private readonly logger = new Logger(FamilyInviteUpdate.name);

    constructor(private readonly familyService: FamilyService) {
        super();
    }

    @SceneEnter()
    async onSceneEnter(@Ctx() ctx: Context) {
        await ctx.reply(
            '–ü—Ä–∏—à–ª–∏—Ç–µ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∏–º—è –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ù–∞–ø—Ä–∏–º–µ—Ä:\n88005555505 –Æ–ª–∏—è\n–ò–ª–∏\nec477d3d-1a13-40b6-a4—è7-3fb1984f1106',
        );
    }

    @Hears(ALL_KEYS_MENU_BUTTON_NAME)
    async exit(@Message('text') menuBtn: string, @Ctx() ctx: WizardContext) {
        await this.telegramService.exitScene(menuBtn, ctx);
    }

    @Hears(/^[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}$/i)
    async inputAccountIdInvitedMember(
        @Ctx() ctx: Context,
        @Message('text', new isAccountIdPipe()) accountIdInvited: string,
        @Sender() sender: SenderTelegram,
    ) {
        const telegramId = String(sender.id);
        const accountIdOwner = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–∏–Ω—è—Ç—å –µ–≥–æ –≤ —Å–µ–º—å—é –ø–æ accountId ${accountIdOwner}`);

        let namePhoneInvited;
        try {
            namePhoneInvited = await this.familyService.getProfileNamePhone(accountIdInvited);
        } catch (e) {
            if (e instanceof NotFoundException || e instanceof HttpException) {
                throw e;
            }
            await ctx.reply('‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–∏–≥–ª–∞—à–∞–µ–º–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
            return;
        }
        try {
            await this.familyService.inviteMember(accountIdOwner, namePhoneInvited);
        } catch (e: any) {
            await ctx.reply(e?.message || '‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        }

        await ctx.reply('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤—ã—Å–ª–∞–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é');
        await ctx.scene.leave();

        const user = await this.familyService.getUserByTelegramId(telegramId);
        await ctx.reply('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', getMainMenuKeyboard(user!.role));
    }

    @On('text')
    async inputFIOInvitedMember(
        @Ctx() ctx: Context,
        @Message('text', new isPhoneNamePipe()) phoneName: PhoneName,
        @Sender() sender: SenderTelegram,
    ) {
        const telegramId = String(sender.id);
        const accountId = await this.familyService.getAccountIdByTelegram(telegramId);

        this.logger.log(
            `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${sender.first_name} - ${sender.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–∏–Ω—è—Ç—å –µ–≥–æ –≤ —Å–µ–º—å—é –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏ –∏–º–µ–Ω–∏ –¥–ª—è accountId ${accountId}`,
        );

        try {
            await this.familyService.inviteMember(accountId, phoneName);
        } catch (e: any) {
            await ctx.reply(e?.message || '‚ùå –ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        }

        await ctx.reply('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤—ã—Å–ª–∞–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é');
        await ctx.scene.leave();

        const user = await this.familyService.getUserByTelegramId(telegramId);
        await ctx.reply('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', getMainMenuKeyboard(user!.role));
    }
}
